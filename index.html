<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phamily Customers Map</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#fff9ef; --fg:#0f2e1d; --accent:#2a8a52; --accent-2:#1d6e3c; --muted:#e5efe5; --card:#ffffff; }
    html, body { height:100%; }
    body { margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--fg); }
    .container { max-width:1200px; margin:0 auto; padding:16px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .title { font-size:20px; font-weight:700; letter-spacing:0.2px; }
    .controls { display:grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap:8px; background:var(--card); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); border:1px solid #f2eadf; }
    .control { display:flex; flex-direction:column; gap:6px; }
    label { font-size:12px; color:#385b47; }
    select, input[type="text"] { padding:8px 10px; border-radius:12px; border:1px solid #dfd6ca; background:#fff; outline:none; }
    .checkbox-row { display:flex; align-items:center; gap:8px; margin-top:22px; }
    .btn { background:var(--accent); color:white; border:none; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#e7f2ea; color:var(--accent); }
    #legend { margin:10px 0 6px; font-size:14px; color:#375a47; }
    #map { width:100%; height:70vh; border-radius:20px; background:var(--card); box-shadow:0 12px 28px rgba(0,0,0,.07); }
    .footer { margin-top:12px; font-size:12px; color:#546e60; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:var(--muted); color:#18432a; font-weight:600; margin-right:8px; }
    @media (max-width:900px) { .controls { grid-template-columns: repeat(2, 1fr); } }
  </style>
  <script>
    const STATE_CENTROIDS = {
      'AL':[32.806671,-86.791130],'AK':[61.370716,-152.404419],'AZ':[33.729759,-111.431221],
      'AR':[34.969704,-92.373123],'CA':[36.116203,-119.681564],'CO':[39.059811,-105.311104],
      'CT':[41.6,-72.7],'DE':[39.0,-75.5],'FL':[27.766279,-81.686783],'GA':[33.040619,-83.643074],
      'HI':[21.094318,-157.498337],'ID':[44.240459,-114.478828],'IL':[40.349457,-88.986137],
      'IN':[39.849426,-86.258278],'IA':[42.011539,-93.210526],'KS':[38.526600,-96.726486],
      'KY':[37.668140,-84.670067],'LA':[31.169546,-91.867805],'ME':[44.693947,-69.381927],
      'MD':[39.063946,-76.802101],'MA':[42.230171,-71.530106],'MI':[43.326618,-84.536095],
      'MN':[45.694454,-93.900192],'MS':[32.741646,-89.678696],'MO':[38.456085,-92.288368],
      'MT':[46.921925,-110.454353],'NE':[41.125370,-98.268082],'NV':[38.313515,-117.055374],
      'NH':[43.452492,-71.563896],'NJ':[40.298904,-74.521011],'NM':[34.840515,-106.248482],
      'NY':[42.165726,-74.948051],'NC':[35.630066,-79.806419],'ND':[47.528912,-99.784012],
      'OH':[40.388783,-82.764915],'OK':[35.565342,-96.928917],'OR':[44.572021,-122.070938],
      'PA':[40.590752,-77.209755],'RI':[41.680893,-71.511780],'SC':[33.856892,-80.945007],
      'SD':[44.299782,-99.438828],'TN':[35.747845,-86.692345],'TX':[31.054487,-97.563461],
      'UT':[40.150032,-111.862434],'VT':[44.045876,-72.710686],'VA':[37.769337,-78.169968],
      'WA':[47.400902,-121.490494],'WV':[38.491226,-80.954453],'WI':[44.268543,-89.616508],
      'WY':[42.755966,-107.302490],'DC':[38.9072,-77.0369]
    };

    function getParams(){
      const p = new URLSearchParams(window.location.search);
      return { state:p.get('state')||'', type:p.get('type')||'', spec:p.get('spec')||'', q:p.get('q')||'', labels: p.get('labels')==='1' };
    }
    function setParams(params){
      const p = new URLSearchParams();
      if(params.state) p.set('state', params.state);
      if(params.type) p.set('type', params.type);
      if(params.spec) p.set('spec', params.spec);
      if(params.q) p.set('q', params.q);
      if(params.labels) p.set('labels','1');
      const url = `${location.pathname}?${p.toString()}`;
      history.replaceState(null,'',url);
      return url;
    }
    function shorten(str, n=60){ return (str && str.length>n) ? str.slice(0, n-1) + '…' : str; }
    function uniqueSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> (a||'').localeCompare(b||'')); }

    function buildControls(data){
      const types = uniqueSorted(data.map(d=>d["Customer Type"]||""));
      const specs = uniqueSorted(data.map(d=>d["Org Specialty"]||""));
      const states = uniqueSorted(data.map(d=>d["State"]||""));
      const selType = document.getElementById('type');
      const selSpec = document.getElementById('spec');
      const selState = document.getElementById('state');
      ["", ...types].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v||"All types"; selType.appendChild(o); });
      ["", ...specs].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v||"All specialties"; selSpec.appendChild(o); });
      ["", ...states].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v||"All states"; selState.appendChild(o); });
    }

    function filterData(data, f){
      return data.filter(d=>{
        if (f.state && d.State !== f.state) return false;
        if (f.type && d["Customer Type"] !== f.type) return false;
        if (f.spec && d["Org Specialty"] !== f.spec) return false;
        if (f.q){
          const hay = (d["Organization Name"]+" "+d.City+" "+d.State+" "+(d["Org Specialty"]||"")+" "+(d["Customer Type"]||"")).toLowerCase();
          if (!hay.includes(f.q.toLowerCase())) return false;
        }
        return true;
      });
    }

    function computeStateGroups(data){
      const g = {};
      data.forEach(d=>{
        const s = d.State;
        if(!g[s]) g[s]=[];
        g[s].push({name: d["Organization Name"], spec: d["Org Specialty"]});
      });
      return g;
    }

    function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }
    function rand(seed){ let x = seed >>> 0; return function(){ x = (1664525*x + 1013904223) % 4294967296; return x/4294967296; } }

    function buildTraces(filtered, showLabels){
      const jitterByStateScale = (s)=> (["CT","RI","MA","NJ","DE","MD","DC","HI"].includes(s) ? 0.18 : 0.55);
      const lats=[], lons=[], texts=[], labels=[];
      filtered.forEach(d=>{
        const s = d.State; const c = STATE_CENTROIDS[s]; if(!c) return;
        const seed = hashCode(d["Organization Name"] + "|" + s); const r = rand(seed); const js = jitterByStateScale(s);
        const lat = c[0] + (r()*1.0 - 0.5) * js; const lon = c[1] + (r()*1.0 - 0.5) * js * 1.3;
        lats.push(lat); lons.push(lon);
        const spec = d["Org Specialty"] ? `<br><i>${d["Org Specialty"]}</i>` : "";
        texts.push(`<b>${d["Organization Name"]}</b>${spec}<br>${d.City || ""}, ${s}`);
        labels.push(d["Organization Name"]);
      });

      const scatter = {
        type:"scattergeo", mode: showLabels ? "markers+text" : "markers",
        lon:lons, lat:lats, text: showLabels ? labels : undefined, textposition:"top center",
        marker:{ size:7, opacity:0.9, line:{width:0.5, color:"#ffffff"}, color:"#2a8a52" },
        name:"Customers", hoverinfo:"text", hovertext:texts
      };

      const groups = computeStateGroups(filtered);
      const locations = Object.keys(groups);
      const z = locations.map(s=> groups[s].length);
      const hover = locations.map(s=> {
        const lines = groups[s].slice().sort((a,b)=> a.name.localeCompare(b.name)).map(o=> "• " + shorten(o.name, 48) + (o.spec ? " — " + shorten(o.spec, 36) : "")).join("<br>");
        return `<b>${s}</b>: ${groups[s].length} customer(s)<br>${lines}`;
      });

      const choropleth = {
        type:"choropleth", locations, z, locationmode:"USA-states", text:hover, hoverinfo:"text",
        colorscale:[[0,"#e5efe5"],[1,"#1d6e3c"]], marker:{line:{color:"white", width:0.8}}, colorbar:{title:"Customers"},
        name:"States (hover for customers)"
      };

      return {scatter, choropleth, total: filtered.length};
    }

    function renderLegend(filtered){
      const counts={}; filtered.forEach(d=>{ counts[d.State]=(counts[d.State]||0)+1; });
      const pairs = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
      const top = pairs.slice(0,8).map(([s,c])=> `<span class="pill">${s}: ${c}</span>`).join("");
      document.getElementById('legend').innerHTML = top || '<span class="pill">No results</span>';
    }

    function draw(filtered, showLabels){
      const traces = buildTraces(filtered, showLabels);
      const layout = {
        title:{ text:"Phamily Customers Across the USA", x:0.02, xanchor:"left" },
        geo:{ scope:"usa", projection:{type:"albers usa"}, showland:true, landcolor:"#fff", bgcolor:"#fff9ef" },
        paper_bgcolor:"#fff9ef", plot_bgcolor:"#fff9ef", margin:{l:10,r:10,t:50,b:10}, legend:{bgcolor:"rgba(255,255,255,0.8)"}
      };
      Plotly.react('map', [traces.choropleth, traces.scatter], layout, {displayModeBar:false});
      document.getElementById('total').textContent = traces.total;
      renderLegend(filtered);
    }

    function getFilters(){
      return {
        state: document.getElementById('state').value,
        type: document.getElementById('type').value,
        spec: document.getElementById('spec').value,
        q: document.getElementById('q').value.trim(),
        labels: document.getElementById('labels').checked
      };
    }

    function applyFiltersFromUI(){
      const f = getFilters();
      setParams(f);
      draw(filterData(CUSTOMER_DATA, f), f.labels);
    }

    function loadFromParams(){
      const p = getParams();
      if (p.state) document.getElementById('state').value = p.state;
      if (p.type) document.getElementById('type').value = p.type;
      if (p.spec) document.getElementById('spec').value = p.spec;
      if (p.q) document.getElementById('q').value = p.q;
      document.getElementById('labels').checked = !!p.labels;
      draw(filterData(CUSTOMER_DATA, p), !!p.labels);
    }

    function copyShareLink(){
      const url = setParams(getFilters());
      navigator.clipboard.writeText(location.origin + url).then(()=>{
        const btn = document.getElementById('share'); const old = btn.textContent; btn.textContent="Link copied!";
        setTimeout(()=> btn.textContent = old, 1200);
      });
    }

    document.addEventListener('DOMContentLoaded', function(){
      buildControls(CUSTOMER_DATA);
      loadFromParams();
      document.querySelectorAll('select,input').forEach(el=> el.addEventListener('change', applyFiltersFromUI));
      document.getElementById('q').addEventListener('input', ()=>{ clearTimeout(window.__deb); window.__deb=setTimeout(applyFiltersFromUI,250); });
      document.getElementById('share').addEventListener('click', copyShareLink);
      document.getElementById('reset').addEventListener('click', ()=>{
        document.getElementById('state').value=''; document.getElementById('type').value=''; document.getElementById('spec').value='';
        document.getElementById('q').value=''; document.getElementById('labels').checked=false; applyFiltersFromUI();
      });
    });
  </script>
  <script src="data.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Phamily Customers Map</div>
      <div><span id="total" class="pill">0</span> total</div>
    </div>
    <div class="controls">
      <div class="control">
        <label for="state">State</label>
        <select id="state"></select>
      </div>
      <div class="control">
        <label for="type">Customer Type</label>
        <select id="type"></select>
      </div>
      <div class="control">
        <label for="spec">Org Specialty</label>
        <select id="spec"></select>
      </div>
      <div class="control">
        <label for="q">Search</label>
        <input id="q" type="text" placeholder="Search organization, city, specialty..." />
      </div>
      <div class="control checkbox-row">
        <input id="labels" type="checkbox" />
        <label for="labels">Show labels</label>
      </div>
      <div class="control" style="margin-top:22px; display:flex; gap:8px;">
        <button class="btn" id="share" type="button">Copy shareable link</button>
        <button class="btn secondary" id="reset" type="button">Reset</button>
      </div>
    </div>
    <div id="legend"></div>
    <div id="map"></div>
    <div class="footer">Tip: Add <code>?state=TX</code> (and <code>type</code>/<code>spec</code>/<code>q</code>/<code>labels</code>) to prefilter for reps.</div>
  </div>
</body>
</html>
